---

# additional disks setup for terraform role
#
#

# Filter the additional virtual disks and create 1 partition
# for each disk.
# Es. For each disk you have:
# vdb
# └─vdb1
# vdc
# └─vdc1
- name: Create disk partitions
  parted:
    device: "/dev/{{ item }}"
    number: 1
    state: present
  with_items:
    - "{{ ansible_devices.keys() | select('match','vd[b-z]') | list }}"

# For each partition previously created
# the task format the unique partition with
# the filesystem type specified into the inventory,
# or with the default if not specified.
- name: Format disks
  filesystem:
    dev: "/dev/{{ item.1 }}1"
    fstype: "{{ item.0['format'] }}"
  with_together:
    - "{{ data_disks.values() | list }}"
    - "{{ ansible_devices.keys() | select('match','vd[b-z]') | sort | list }}"

# Set the facts again after the previous tasks
# to update the informations about created disks.
# This is useful to get the newest partition UUIDs.
- name: Set Facts
  setup:
    gather_subset:
      - hardware

# For each disk, create its related mount point
# if specified into the inventory.
# If not specified, the assert must exit the playbook execution.
- name: Create disks mountpoint
  file:
    path: "{{ item['mount_point'] }}"
    state: directory
  with_items:
    - "{{ data_disks.values() | list }}"

# Mount each disk on the related mountpoint,
# generating the entry into the /etc/fstab file.
- name: Mount disks
  mount:
    path: "{{ item.0['mount_point'] }}"
    src: "UUID={{ ( ansible_devices[item.1].partitions.values() | list )[0].uuid }}"
    fstype: "{{ item.0['format'] }}"
    state: mounted
  with_together:
    - "{{ data_disks.values() | list }}"
    - "{{ ansible_devices.keys() | select('match','vd[b-z]') | sort | list }}"
